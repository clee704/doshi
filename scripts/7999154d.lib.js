"use strict";function swap(a,b,c){var d=a[b];a[b]=a[c],a[c]=d}function range(a,b,c){var d=0;if(void 0===b?b=a:d=a,void 0===c&&(c=1),0===c)throw new RangeError("range() step argument must not be zero");var e,f=[];if(b>d){if(c>0)for(e=d;b>e;e+=c)f.push(e)}else if(0>c)for(e=d;e>b;e+=c)f.push(e);return f}function mapObj(a,b){for(var c={},d=0;d<a.length;d++){var e=a[d],f=b.call(void 0,e,d);c[e]=f}return c}function objValues(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b}function objMap(a,b){var c=[];for(var d in a)a.hasOwnProperty(d)&&c.push(b.call(a,d));return c}function zip(a,b){for(var c=[],d=Math.min(a.length,b.length),e=0;d>e;e++)c.push([a[e],b[e]]);return c}function setPartitions(a,b){var c=_setPartitions(a);return void 0!==b&&(c=c.filter(function(a){for(var c=0;c<a.length;c++)if(a[c].length>b)return!1;return!0})),c}function _setPartitions(a){if(1===a.length)return[[a]];for(var b=a.slice(),c=b.splice(-1),d=b,e=_setPartitions(d),f=[],g=0;g<e.length;g++){for(var h=e[g],i=0;i<h.length;i++){var j=h.slice(),k=j.splice(i,1)[0],l=j;f.push(l.concat([k.concat(c)]))}f.push(h.concat([c]))}return f}function sortPartitions(a){for(var b=0;b<a.length;b++){var c=a[b];c.sort(_compareSubsets)}return a.sort(_comparePartitions),a}function _compareSubsets(a,b){var c=a.length-b.length;return c?c:b>a?-1:a>b?1:0}function _comparePartitions(a,b){var c=a.length-b.length;if(c)return-c;for(var d=0;d<a.length;d++)if(c=_compareSubsets(a[d],b[d]))return c;return 0}function permutations(a,b){var c=[],d=a.length;if(void 0===b&&(b=d),b>d)return c;var e=range(d),f=range(d,d-b,-1),g=function(b){return a[b]};c.push(e.slice(0,b).map(g));for(var h=!1;!h;){h=!0;for(var i=b-1;i>=0;i--){if(f[i]-=1,0!==f[i]){var j=f[i];swap(e,i,d-j),c.push(e.slice(0,b).map(g)),h=!1;break}var k=e.splice(i,1);e.push(k),f[i]=d-i}}return c}function square(a){return a*a}function sum(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b}function variance(a){var b=a.length;return sum(a.map(square))/b-square(sum(a)/b)}function randint(a,b){return a+Math.floor(Math.random()*(b-a+1))}function shuffle(a){for(var b=a.length-1;b>=1;b--){var c=randint(0,b);swap(a,b,c)}}function isDeepEmpty(a){for(var b=0;b<a.length;b++){var c=a[b];if(c instanceof Array){if(isDeepEmpty(c))continue;return!1}if(c)return!1}return!0}function hillClimbing(a){for(var b,c=a.evaluate();;){b=void 0;var d=a.moves();shuffle(d);for(var e=0;e<d.length;e++){var f=d[e];a.move(f);var g=a.evaluate();a.compareFitness(g,c)<0&&(c=g,b=f),a.undo()}if(void 0===b)break;a.move(b)}return c}function Problem(a){this.courses=a.courses,this.classes=a.classes,this.days=[0,1,2,3,4],this.inputTimetable=a.inputTimetable,this.maxClasses=a.maxClasses||this.classes.length,this.courseHours=a.courseHours,this.timetable=[],this._makeAvailableTimes(),this._makeTimeAllocs(),this.initRandom()}Problem.prototype._makeAvailableTimes=function(){for(var a=[],b=0;b<this.inputTimetable.length;b++)for(var c=this.inputTimetable[b],d=0;d<c.length;d++){var e=c[d];e&&e[0]&&e[0].length&&a.push([b,d].concat(e))}this._availableTimes=a},Problem.prototype._makeTimeAllocs=function(){for(var a=[],b=0,c=0;c<this._availableTimes.length;c++){var d=this._availableTimes[c],e=d[1];e+1>b&&(b=e+1);var f=d[2],g=d[3];g&&0!==g.length||(g=this.courses);for(var h=[],i=setPartitions(f,this.maxClasses),j=0;j<i.length;j++){var k=i[j];if(!(g.length<k.length))for(var l=permutations(g,k.length),m=0;m<l.length;m++){var n=l[m],o=zip(n,k);h.push(o)}}a.push(h)}this._timeAllocs=a,this._numPeriods=b},Problem.prototype.initRandom=function(){var a=this,b=function(){return 0},c=function(){return mapObj(a.days,b)},d=function(){return mapObj(a.courses,b)};this._c={courses:d(),varCourses:0,sumCourses:0,coursesByClass:mapObj(this.classes,d),sumVarCoursesByClass:0,sumCoursesByClass:mapObj(this.classes,b),daysByCourse:mapObj(this.courses,c),sumVarDaysByCourse:0,sumDaysByCourse:d(),coursesByDayByClass:mapObj(this.classes,function(){return mapObj(a.days,d)}),sumVarCoursesByDayByClass:0,sumCoursesByDayByClass:mapObj(this.classes,c)},this._c.varCourses=this._computeVarCourses(),this.timetable=[],this.timetable.length=this._availableTimes.length;for(var e=0;e<this._availableTimes.length;e++){var f=randint(0,this._timeAllocs[e].length-1);this._setSlot(e,f)}this._history=[]},Problem.prototype._setSlot=function(a,b){var c=this._availableTimes[a][0],d=this._timeAllocs[a][b];if(void 0===d)throw new Error("The problem is unsolvable");for(var e=0;e<d.length;e++){var f=d[e][0],g=d[e][1];this._updateCourses(f,1),this._updateDaysByCourse(f,c,1);for(var h=0;h<g.length;h++){var i=g[h];this._updateCoursesByClass(i,f,1),this._updateCoursesByDayByClass(i,c,f,1)}}this.timetable[a]=b},Problem.prototype._unsetSlot=function(a){for(var b=this.timetable[a],c=this._availableTimes[a][0],d=this._timeAllocs[a][b],e=0;e<d.length;e++){var f=d[e][0],g=d[e][1];this._updateCourses(f,-1),this._updateDaysByCourse(f,c,-1);for(var h=0;h<g.length;h++){var i=g[h];this._updateCoursesByClass(i,f,-1),this._updateCoursesByDayByClass(i,c,f,-1)}}this.timetable[a]=void 0},Problem.prototype._computeVarCourses=function(){var a=this.courseHours,b=this._c.courses,c=this.courses.length;return a?"object"==typeof a?sum(objMap(this.courseHours,function(c){return square(b[c]-a[c])}))/c:sum(this.courses.map(function(c){return square(b[c]-a)}))/c:variance(objValues(b))},Problem.prototype._updateCourses=function(a,b){var c=this._c,d=c.courses,e=d[a],f=c.sumCourses;d[a]+=b,c.sumCourses+=b;var g=this.courses.length,h=2*b,i=b*b;c.varCourses+=this.courseHours?"object"==typeof this.courseHours?(h*(e-this.courseHours[a])+i)/g:(h*(e-this.courseHours)+i)/g:(h*e+i)/g-(h*f+i)/(g*g)},Problem.prototype._updateDaysByCourse=function(a,b,c){var d=this._c,e=d.daysByCourse[a],f=e[b],g=d.sumDaysByCourse[a];e[b]+=c,d.sumDaysByCourse[a]+=c;var h=this.days.length,i=2*c,j=c*c;d.sumVarDaysByCourse+=(i*f+j)/h-(i*g+j)/(h*h)},Problem.prototype._updateCoursesByClass=function(a,b,c){var d=this._c,e=d.coursesByClass[a],f=e[b],g=d.sumCoursesByClass[a];e[b]+=c,d.sumCoursesByClass[a]+=c;var h=this.courses.length,i=2*c,j=c*c;d.sumVarCoursesByClass+=(i*f+j)/h-(i*g+j)/(h*h)},Problem.prototype._updateCoursesByDayByClass=function(a,b,c,d){var e=this._c,f=e.coursesByDayByClass[a][b],g=f[c],h=e.sumCoursesByDayByClass[a][b];f[c]+=d,e.sumCoursesByDayByClass[a][b]+=d;var i=this.courses.length,j=2*d,k=d*d;e.sumVarCoursesByDayByClass+=(j*g+k)/i-(j*h+k)/(i*i)},Problem.prototype.evaluate=function(){var a=this._c;return[Math.round(1e6*a.varCourses)/1e6,Math.round(1e6*a.sumVarCoursesByClass)/1e6,Math.round(1e6*a.sumVarCoursesByDayByClass)/1e6,Math.round(1e6*a.sumVarDaysByCourse)/1e6,a.sumCourses]},Problem.prototype.compareFitness=function(a,b){var c,d;return c=a[0],d=b[0],d>c?-1:c>d?1:(c=a[1],d=b[1],d>c?-1:c>d?1:(c=a[2],d=b[2],d>c?-1:c>d?1:(c=a[3],d=b[3],d>c?-1:c>d?1:0)))},Problem.prototype.moves=function(){for(var a=[],b=0;b<this._availableTimes.length;b++)for(var c=0;c<this._timeAllocs[b].length;c++)a.push([b,c]);return a},Problem.prototype.move=function(a){var b=a[0],c=a[1];this._history.push([b,this.timetable[b]]),this._unsetSlot(b),this._setSlot(b,c)},Problem.prototype.undo=function(){var a=this._history.pop(),b=a[0],c=a[1];this._unsetSlot(b),this._setSlot(b,c)},Problem.prototype.convertTimetable=function(a){for(var b,c,d,e,f=[],g=0;g<this.days.length;g++)b=[],b.length=this._numPeriods,f.push(b);for(var h=0;h<this._availableTimes.length;h++){var i=this._availableTimes[h];c=i[0],d=i[1],e=this._timeAllocs[h][a[h]],f[c][d]=e}var j=mapObj(this.courses,function(a,b){return b}),k=function(a,b){return j[a[0]]-j[b[0]]};for(c=0;c<f.length;c++)for(b=f[c],d=0;d<b.length;d++)e=b[d],e&&e.sort(k);return f};