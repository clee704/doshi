"use strict";angular.module("doshi",["ngRoute","ngAnimate"]),angular.module("doshi").controller("CoursesAndClassesInputCtrl",["$scope","problemArgs","appService",function(a,b,c){a.page=a.getCurrentPage(),a.courses=b.courses,a.classes=b.classes,a._problemArgs=b,a.loadExample=function(){c.loadExample()},a.addCourse=function(){c.addCourse(a.newCourse),a.newCourse=""},a.removeCourse=function(a){c.removeCourse(a)},a.addClass=function(){c.addClass(a.newClass),a.newClass=""},a.removeClass=function(a){c.removeClass(a)},a.$watch("courses",c.onDataChange,!0),a.$watch("classes",c.onDataChange,!0),a.$watch("_problemArgs.inputTimetable",c.onDataChange,!0),a.$watch("_problemArgs.maxClasses",c.onDataChange),a.$watch("_problemArgs.courseHours",c.onDataChange),a.$watch("_problemArgs.courseHoursByCourse",c.onDataChange,!0)}]).animation(".list-group-item",["getCssRule",function(a){var b=".input-courses-and-classes .list-group-item:not(.empty).ng-leave",c=a(b);return{leave:function(a,b){a.is(":not(.empty)")&&c&&(c.style.height=a.height()+"px"),b()}}}]),angular.module("doshi").controller("TimesInputCtrl",["$scope","problemArgs","appService",function(a,b,c){a.page=a.getCurrentPage(),a.dayIndices=c.dayIndices,a.periodIndices=c.periodIndices,a.inputTimetable=b.inputTimetable,a.$watch("inputTimetable",c.onDataChange,!0)}]),angular.module("doshi").controller("EtcInputCtrl",["$scope","problemArgs","appService",function(a,b,c){a.page=a.getCurrentPage(),a.problemArgs=b,a.$watch("problemArgs.maxClasses",c.onDataChange),a.$watch("problemArgs.courseHours",c.onDataChange),a.$watch("problemArgs.courseHoursByCourse",c.onDataChange,!0)}]),angular.module("doshi").config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/input-step1.html",controller:"CoursesAndClassesInputCtrl",routeName:"Step 1"}).when("/input-times",{templateUrl:"views/input-step2.html",controller:"TimesInputCtrl",routeName:"Step 2"}).when("/input-etc",{templateUrl:"views/input-step3.html",controller:"EtcInputCtrl",routeName:"Step 3"}).when("/output",{templateUrl:"views/output.html",controller:"OutputCtrl",routeName:"Output"}).otherwise({redirectTo:"/"})}]).controller("NavCtrl",["$scope","$location","$route",function(a,b){a.pages=[{path:"/",title:"교과목/반 입력"},{path:"/input-times",title:"시간 입력"},{path:"/input-etc",title:"기타 설정"},{path:"/output",title:"시간표 만들기"}],a.pageTransitionDirection="forward";var c,d=mapObj(a.pages.map(function(a){return a.path}),function(a,b){return b});!function(){for(var b=0;b<a.pages.length;b++){var c=a.pages[b];b>0&&(c.prevPage=a.pages[b-1]),b<a.pages.length-1&&(c.nextPage=a.pages[b+1])}}(),a.$on("$locationChangeSuccess",function(){var e=b.path(),f=d[c],g=d[e];a.pageTransitionDirection=void 0===f||g>=f?"forward":"backward",c=e,a.path=e}),a.getCurrentPage=function(){return a.pages[d[b.path()]]}}]).animation(".view",["getCssRule","scrollTo",function(a,b){function c(a){return function(c,d){var f,g=c.parent().is(".forward"),h=angular.element(".container").outerWidth();f=g&&a||!g&&!a?"translate("+h+"px, 0)":"translate(-"+h+"px, 0)";var i=g?a?0:1:a?2:3,j=e[i];j&&(j.style["-webkit-transform"]=f,j.style["-ms-transform"]=f,j.style.transform=f),a||(console.log("will listen to transitionend"),c.on("transitionend",function(){console.log("will scroll"),b(".view-wrapper")})),d()}}var d=[".forward .view.ng-enter",".forward .view.ng-leave.ng-leave-active",".backward .view.ng-enter",".backward .view.ng-leave.ng-leave-active"],e=d.map(a);return{enter:c(!0),leave:c(!1)}}]),angular.module("doshi").controller("OutputCtrl",["$scope","problemArgs","appService","screenclick",function(a,b,c,d){function e(){a.highlightedCourse=void 0,a.highlightedClass=void 0;for(var b=0;b<c.numDays;b++){a.isHighlighted[b]=[];for(var d=0;d<c.numPeriods;d++)a.isHighlighted[b][d]=[]}}a.page=a.getCurrentPage(),a.dayIndices=c.dayIndices,a.periodIndices=c.periodIndices,a.status=c.status,a.timetable=c.timetable,a.timetableStats=c.timetableStats,a.isHighlighted=[],a.highlightedCourse=void 0,a.highlightedClass=void 0,a.start=function(){c.start()},a.pause=function(){c.pause()},a.resume=function(){c.resume()},a.highlightCourse=function(b){a.highlightedCourse=b,a.highlightedClass=void 0;for(var d=0;d<c.numDays;d++)for(var e=0;e<c.numPeriods;e++){a.isHighlighted[d][e]=[];var f=c.timetable[d][e];if(f)for(var g=0;g<f.length;g++)if(f[g][0]===b){a.isHighlighted[d][e][g]=!0;break}}},a.highlightClass=function(b){a.highlightedCourse=void 0,a.highlightedClass=b;for(var d=0;d<c.numDays;d++)for(var e=0;e<c.numPeriods;e++){a.isHighlighted[d][e]=[];var f=c.timetable[d][e];if(f)for(var g=0;g<f.length;g++){for(var h=f[g][1],i=0;i<h.length;i++)if(h[i]===b){a.isHighlighted[d][e][g]=!0;break}if(a.isHighlighted[d][e][g])break}}},d(function(){a.$apply(e)}),e()}]),angular.module("doshi").directive("maximizeHeight",["$window","$timeout","debounce",function(a,b,c){var d={};return angular.element(a).on("resize",c(function(){for(var a in d)d.hasOwnProperty(a)&&d[a]()},400)),{link:function(a,c,e){function f(){c.hasClass("height-maximized")&&c.css("height","").removeClass("height-maximized"),b(function(){if(!e.resizeIf||a.$eval(e.resizeIf)){var b=c.height(),d=c.parent().height()+1;b!==d&&c.css("height",d+"px").addClass("height-maximized")}})}d[a.$id]=f,a.$on("$destroy",function(){delete d[a.$id]}),a.$watch(e.watch,f,!0)}}}]),angular.module("doshi").directive("ngEnter",["$parse",function(a){return{link:function(b,c,d){var e=a(d.ngEnter);c.on("keypress",function(a){(13===a.which||10===a.which)&&b.$apply(function(){e(b,{$event:a})})})}}}]),angular.module("doshi").directive("progressBar",function(){return{scope:{value:"=model"},templateUrl:"templates/progress-bar.html"}}),angular.module("doshi").directive("removeOutline",function(){return{link:function(a,b){b.on("click",function(a){a.clientX>0&&a.clientY>0&&b.blur()})}}}),angular.module("doshi").service("appService",["$timeout","Solver","problemArgs","localStorage",function(a,b,c,d){function e(){for(var a=function(){return 0},b={daysByCourse:mapObj(c.courses,function(){return mapObj(f.dayIndices,a)}),sumDaysByCourse:mapObj(c.courses,a),coursesByClass:mapObj(c.classes,function(){return mapObj(c.courses,a)}),sumCoursesByClass:mapObj(c.classes,a)},d=0;d<f.numDays;d++){var e=f.timetable[d];if(e)for(var g=0;g<f.numPeriods;g++){var h=e[g];if(h)for(var i=0;i<h.length;i++){var j=h[i][0],k=h[i][1];b.daysByCourse[j][d]+=1,b.sumDaysByCourse[j]+=1;for(var l=0;l<k.length;l++){var m=k[l];b.coursesByClass[m][j]+=1,b.sumCoursesByClass[m]+=1}}}}angular.copy(b,f.timetableStats)}var f=this;this.version=0,this.numDays=5,this.numPeriods=7,this.dayIndices=range(this.numDays),this.periodIndices=range(this.numPeriods),this.solver=new b,this.status={emptyInput:!0,inputChanged:!1,showHelp:!0,running:!1,paused:!1,finished:!1,progress:{current:0,max:0,percent:0}},this.timetable=[],this.timetableStats={daysByCourse:{},coursesByClass:{}},this.exampleData={courses:["국어","수학","직업","체육"],classes:["1-3","1-4","2-2","2-7","3-6","3-7"],inputTimetable:[[[["1-3"],["국어","수학"]],[["1-3","2-7","3-6","3-7"]],[["2-7","3-6"]],[["3-7"]],[],[],[]],[[["3-6"]],[],[],[["1-3","2-7"]],[["2-2"]],[["2-2","3-7"]],[["2-2"]]],[[],[],[],[],[["1-4","3-7"]],[["1-4","2-7"]],[]],[[["1-4","2-2","3-6","3-7"]],[["2-2","2-7","3-6"]],[],[],[["1-4"]],[["2-7"]],[["1-3","2-7","3-7"]]],[[["2-2","3-7"]],[["1-3","1-4"]],[["1-3","2-2","2-7","3-6"]],[["1-4"]],[["1-3","2-7"]],[["1-3","2-7","3-7"]],[]]],maxClasses:2,courseHours:9,courseHoursByCourse:{}},this.loadExample=function(){angular.copy(this.exampleData.courses,c.courses),angular.copy(this.exampleData.classes,c.classes),angular.copy(this.exampleData.inputTimetable,c.inputTimetable),this.status.emptyInput=isDeepEmpty(c.inputTimetable),c.maxClasses=this.exampleData.maxClasses,c.courseHours=this.exampleData.courseHours,angular.copy(this.exampleData.courseHoursByCourse,c.courseHoursByCourse)},this.onDataChange=function(a,b){a!==b&&(this.status.emptyInput=isDeepEmpty(c.inputTimetable),(this.timetable.length||this.status.running||this.status.paused)&&(this.status.inputChanged=!0),this.save())}.bind(this),this.save=function(){var a={version:this.version,status:this.status,timetable:this.timetable,timetableStats:this.timetableStats,problemArgs:c};d.dump("doshiSavedData",a)},this.load=function(){var a=d.load("doshiSavedData");if(null!==a){if(a.version!==this.version)return d.removeItem("doshiSavedData"),void 0;angular.copy(a.problemArgs,c),angular.copy(a.timetable,this.timetable),angular.copy(a.timetableStats,this.timetableStats),this.status.emptyInput=a.status.emptyInput,this.status.inputChanged=a.status.inputChanged,this.status.showHelp=a.status.showHelp,this.timetable.length||(this.status.inputChanged=!1)}},this.addCourse=function(a){a&&-1===c.courses.indexOf(a)&&c.courses.push(a)},this.removeCourse=function(a){var b=c.courses.indexOf(a);if(-1!==b){c.courses.splice(b,1);for(var d=function(b){return a!==b},e=0;e<this.numDays;e++)for(var f=0;f<this.numPeriods;f++){var g=c.inputTimetable[e][f];if(g){var h=g[1];h&&angular.copy(h.filter(d),h)}}}},this.addClass=function(a){a&&-1===c.classes.indexOf(a)&&c.classes.push(a)},this.removeClass=function(a){var b=c.classes.indexOf(a);if(-1!==b){c.classes.splice(b,1);for(var d=function(b){return a!==b},e=0;e<this.numDays;e++)for(var f=0;f<this.numPeriods;f++){var g=c.inputTimetable[e][f];if(g){var h=g[0];if(h){angular.copy(h.filter(d),h);var i=g[1];0===h.length&&i&&(i.length=0)}}}}},this.start=function(){this.solver.start()},this.pause=function(){this.solver.pause()},this.resume=function(){this.solver.resume()};var g=this.status,h={started:function(){a(function(){f.timetable.length=0,g.inputChanged=!1,g.showHelp=!1,g.running=!0,g.paused=!1,g.finished=!1,g.progress.current=0,g.progress.max=0,g.progress.percent=0})},resumed:function(){a(function(){g.showHelp=!1,g.running=!0,g.paused=!1})},paused:function(){a(function(){g.finished||(g.running=!1,g.paused=!0)})},progress:function(b,c){a(function(){g.progress.current=b,g.progress.max=c,g.progress.percent=b/c*100})},solutionfound:function(b,c){a(function(){g.running=!1,g.finished=!0,angular.copy(c,f.timetable),e(),f.save()})},unsolvableproblem:function(a){console.log("unsolvable",a)}};this.solver.on(h),this.load()}]),angular.module("doshi").factory("debounce",["$timeout","time",function(a,b){return function(c,d){function e(){var h=arguments,i=b();void 0===g||g+d>i?(void 0!==f&&a.cancel(f),f=a(function(){e.apply(void 0,h)},d),g=i):(c.apply(void 0,h),g=void 0)}var f,g;return e}}]),angular.module("doshi").factory("getCssRule",["$window",function(a){function b(a){var b=d.insertRule(a+"{}",d.cssRules.length),c=d.cssRules[b].selectorText;return d.deleteRule(b),c}var c=a.document.createElement("style");a.document.head.appendChild(c);var d=c.sheet;return function(c){c=b(c);for(var d=a.document.styleSheets,e=0;e<d.length;e++)for(var f=d[e],g=f.cssRules,h=0;h<g.length;h++){var i=g[h];if(i.type===CSSRule.STYLE_RULE&&i.selectorText===c)return i}console.log("CSS rule for `"+c+"` not found")}}]),angular.module("doshi").service("localStorage",["$window",function(a){var b=a.localStorage;this.getLength=function(){return b.length},this.key=function(a){return b.key(a)},this.getItem=function(a){return b.getItem(a)},this.setItem=function(a,c){return b.setItem(a,c)},this.removeItem=function(a){return b.removeItem(a)},this.clear=function(){return b.clear()},this.dump=function(a,c){return b.setItem(a,angular.toJson(c))},this.load=function(a){var c=b.getItem(a);if(null!==c)try{return angular.fromJson(c)}catch(d){}return null}}]),angular.module("doshi").service("problemArgs",function(){this.courses=[],this.classes=[],this.inputTimetable=[],this.maxClasses=null,this.courseHours=null,this.courseHoursByCourse={}}),angular.module("doshi").factory("screenclick",["$window",function(a){var b=[];return angular.element(a).on("click",function(a){for(var c=0;c<b.length;c++)b[c].call(this,a)}),function(a){b.push(a)}}]),angular.module("doshi").factory("scrollTo",function(){return function(a){console.log("scrollTo",a);var b=angular.element(a),c=b.offset().top;angular.element("body").animate({scrollTop:c-15},"fast")}}),angular.module("doshi").directive("skipNgAnimate",["$animate",function(a){return{compile:function(b){a.enabled(!1,b)}}}]),angular.module("doshi").factory("Solver",["problemArgs","time",function(a,b){function c(){this._workers=[],this._numRunningWorkers=0,this._numSolved=0,this._numMaxRun=1e3,this._startTime=null,this._minFitness=null,this._bestTimetable=null,this._callbacks={},this._init()}function d(a){this._raw=new Worker("scripts/68552076.worker.js"),this._raw.addEventListener("message",a._onMessage.bind(a),!1),this._raw.addEventListener("error",a._onError.bind(a),!1)}return c.prototype._init=function(){for(var a=0;3>a;a++)this._workers.push(new d(this))},c.prototype.start=function(){var c={courses:a.courses,classes:a.classes,inputTimetable:a.inputTimetable,maxClasses:a.maxClasses,courseHours:a.courseHours};try{this.problem=new Problem(c)}catch(d){return this._callback("unsolvableproblem",d),void 0}for(var e=0;e<this._workers.length;e++)this._workers[e].call("setProblem",c);this._numSolved=0,this._minFitness=null,this._bestTimetable=null,this._startTime=b(),this._resume(),this._callback("started")},c.prototype._resume=function(){for(var a=0;a<this._workers.length;a++)this._workers[a].call("start");this._numRunningWorkers=this._workers.length},c.prototype.resume=function(){this._resume(),this._callback("resumed")},c.prototype.pause=function(){this._pause()},c.prototype._pause=function(){for(var a=0;a<this._workers.length;a++)this._workers[a].call("pause")},c.prototype.on=function(a){for(var b in a)a.hasOwnProperty(b)&&(this._callbacks[b]=a[b])},c.prototype._callback=function(){var a=[].slice.call(arguments),b=a[0],c=a.slice(1);this._callbacks[b].apply(void 0,c)},c.prototype.onResult=function(a,b){this._numSolved+=1,(null===this._minFitness||this.problem.compareFitness(a,this._minFitness)<=0)&&(this._minFitness=a,this._bestTimetable=b,this._debug()),this._callback("progress",this._numSolved,this._numMaxRun),this._numSolved===this._numMaxRun&&(this._pause(),this._callback("solutionfound",this._minFitness,this.problem.convertTimetable(this._bestTimetable)),this._debug())},c.prototype._debug=function(){var a=(b()-this._startTime)/1e3;console.log("elapsed time: "+a.toFixed(6)+", num solved: "+this._numSolved+", rate: "+(this._numSolved/a).toFixed(6)+", fitness: "+this._minFitness)},c.prototype.onPaused=function(){this._numRunningWorkers-=1,0===this._numRunningWorkers&&this._callback("paused")},c.prototype._onMessage=function(a){var b=a.data,c=this[b.method];"function"==typeof c&&c.apply(this,b.args)},c.prototype._onError=function(a){console.log("An error occurred in Worker: "+a.message+" ("+a.filename+": "+a.lineno+")")},d.prototype.call=function(){var a=[].slice.apply(arguments),b=a[0],c=a.slice(1);this._raw.postMessage({method:b,args:c})},c}]),angular.module("doshi").factory("time",function(){return function(){return Date.now()}});